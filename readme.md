# 📬 Telegram Email Bot

Бот позволяет отправлять email-сообщения с вложениями через Gmail прямо из Telegram. Используется авторизация OAuth 2.0 и модульная архитектура.

---

## 🚀 Быстрый старт

### 1. Клонируйте или скачайте проект

### 2. Установите зависимости
```bash
pip install -r requirements.txt
```

Минимально:
```bash
pip install aiogram python-dotenv google-auth google-auth-oauthlib
```

### 3. Создайте файл `.env` в корне:
```env
BOT_TOKEN=your_telegram_bot_token
ALLOWED_USER_IDS=123456789,987654321
```

### 3.1. Создайте файл `.env` для email модуля:
```env
# Создайте файл routers/email_router/.env
FROM_EMAIL=your_email@gmail.com
DEFAULT_RECIPIENT=test@test.ru
```

> **🔐 Модульные секреты:** Каждый модуль теперь управляет своими переменными окружения независимо. Email настройки перенесены в модуль для полной автономности.
## 📄 Описание переменных окружения

### 🌍 Глобальные переменные (корневой `.env`)

Эти переменные используются всем ботом и задаются в корневом файле `.env`.

#### 🔐 `BOT_TOKEN`
**Тип:** строка

Токен вашего Telegram-бота, полученный у [@BotFather](https://t.me/BotFather).

Пример:
```env
BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
```

#### 👤 `ALLOWED_USER_IDS`
**Тип:** список ID (через запятую)

Список Telegram user ID, которым разрешено использовать бота. Это защита от неавторизованного доступа.

Пример:
```env
ALLOWED_USER_IDS=123456789,987654321
```

Если пользователь с другим ID попытается использовать бота — он получит сообщение "У вас нет доступа к этому боту."

### 📧 Модульные переменные

Каждый модуль управляет своими секретами независимо в собственном `.env` файле:

- **Email модуль:** `routers/email_router/.env`
- **ChatGPT модуль:** `routers/chatgpt_module/.env` 
- **Audio Transcription модуль:** `routers/audio_transcription_module/.env`
- **Voice Assistant модуль:** `routers/voice_assistant_module/.env`

#### Email модуль (`routers/email_router/.env`)

#### ✉️ `FROM_EMAIL`
**Тип:** строка (email-адрес)

Email, от имени которого будут отправляться письма (должен совпадать с тем, через который вы прошли OAuth авторизацию).

Пример:
```env
FROM_EMAIL=your_email@gmail.com
```

#### 📬 `DEFAULT_RECIPIENT`
**Тип:** строка (email-адрес)

Email получателя по умолчанию. Если пользователь не указал получателя вручную — письма будут направлены на этот адрес.

Пример:
```env
DEFAULT_RECIPIENT=test@test.ru
```

> **🔧 Модульная архитектура:** Каждый модуль управляет своими секретами независимо. Это позволяет создавать полностью автономные модули, которые можно переносить между проектами.

### 4. Настройте email модуль (если нужна отправка почты)

#### 4.1. Добавьте файл `client_secret.json` в email модуль
Скачайте его из [Google Cloud Console](https://console.cloud.google.com/apis/credentials), включив Gmail API. 
Поместите файл в `routers/email_router/auth/client_secret.json`.

#### 4.2. Добавьте свою почту в тестеры проекта 
Через раздел `Audience`, там выберите `Add users` под заголовком `Test users`

[Подробная инструкция по настройке Google Cloud](https://github.com/vladkolchik/Assitant_bot/blob/main/google_cloud_full_setup.md)

#### 4.3. Получите `token.pkl`
```bash
python routers/email_router/auth/script.py
```
Это откроет браузер, где вы авторизуетесь через Gmail. В результате создастся файл `token.pkl` в папке `routers/email_router/auth/`.

> **🔄 Модульная авторизация:** Теперь каждый модуль может иметь свою собственную авторизацию в папке `auth/`. Это позволяет создавать модули для разных сервисов (Google, Discord, Slack и т.д.) без конфликтов.

### 5. Запустите бота
```bash
python bot.py
```

> **📌 Примечание:** Бот будет работать и без настройки email модуля. Основные команды (`/start`, `/menu`) всегда доступны благодаря core модулю. Email функции будут недоступны до настройки модуля.

---

## 📂 Структура проекта
```
project/
├── bot.py                  # Точка входа
├── config.py               # Глобальные переменные окружения
├── messages.py             # Глобальные сообщения (только системные)
├── .env                    # Глобальные секреты (BOT_TOKEN, ALLOWED_USER_IDS)
│
├── routers/                # Все роутеры (модули логики)
│   ├── __init__.py         # Автозагрузка роутеров
│   │
│   ├── core/               # 🏠 Ядро бота (глобальные команды)
│   │   ├── __init__.py     # Экспорт core_router + MENU_CONFIG (order: 1)
│   │   └── router.py       # Команды /start, /menu, main_menu
│   │
│   ├── email_router/       # ✉️ Email модуль (полностью автономный)
│   │   ├── __init__.py     # Экспорт router + MENU_CONFIG (order: 10)
│   │   ├── router.py       # Логика отправки email
│   │   ├── config.py       # Модульные настройки (.env)
│   │   ├── messages.py     # Сообщения модуля
│   │   ├── keyboards.py    # Клавиатуры модуля
│   │   ├── services.py     # Сервисы модуля (Gmail API)
│   │   ├── .env            # Секреты модуля (FROM_EMAIL, DEFAULT_RECIPIENT)
│   │   ├── .env.example    # Шаблон для разработчиков
│   │   ├── README.md       # Документация модуля
│   │   └── auth/           # 🔐 OAuth авторизация Google
│   │       ├── __init__.py         # Экспорт GoogleAuthManager
│   │       ├── auth_manager.py     # Менеджер авторизации
│   │       ├── script.py           # Скрипт получения токенов
│   │       ├── client_secret.json  # Конфиг Google API
│   │       └── token.pkl           # Токены (создается при авторизации)
│   │
│   ├── voice_assistant_module/ # 🎤 Голосовой ассистент (Whisper + ChatGPT)
│   │   ├── __init__.py     # Экспорт router + MENU_CONFIG (order: 10)
│   │   ├── router.py       # Объединенная логика Whisper + ChatGPT
│   │   ├── config.py       # Настройки для Whisper и ChatGPT
│   │   ├── messages.py     # Сообщения голосового ассистента
│   │   ├── .env            # Секреты модуля (OPENAI_API_KEY)
│   │   ├── .env.example    # Шаблон для разработчиков
│   │   └── README.md       # Документация модуля
│   │
│   ├── chatgpt_module/     # 🤖 ChatGPT (OpenAI API)
│   │   ├── __init__.py     # Экспорт router + MENU_CONFIG (order: 15)
│   │   ├── router.py       # Логика ChatGPT общения
│   │   ├── config.py       # Настройки OpenAI API
│   │   ├── messages.py     # Сообщения ChatGPT модуля
│   │   └── README.md       # Документация модуля
│   │
│   ├── audio_transcription_module/ # 🎧 Транскрипция аудио (Whisper)
│   │   ├── __init__.py     # Экспорт router + MENU_CONFIG (order: 12)
│   │   ├── router.py       # Логика Whisper транскрипции
│   │   ├── config.py       # Настройки Whisper API
│   │   ├── messages.py     # Сообщения транскрипции
│   │   └── README.md       # Документация модуля
│   │
│   ├── test_module/        # 🧪 Демо модуль (примеры для разработчиков)
│   │   ├── __init__.py     # Экспорт router + MENU_CONFIG (order: 20)
│   │   ├── router.py       # Примеры обработчиков
│   │   └── messages.py     # Сообщения тестирования
│   │
│   ├── api_example_module/ # 🌐 Пример API модуля с секретами
│   │   ├── __init__.py     # Экспорт router + MENU_CONFIG (order: 25)
│   │   ├── router.py       # Демонстрация работы с API
│   │   ├── config.py       # Управление модульными секретами
│   │   ├── messages.py     # Сообщения API модуля
│   │   ├── .env.example    # Шаблон переменных модуля
│   │   └── README.md       # Документация модуля
│   │
│   └── id_module/          # 🆔 Модуль получения ID
│       ├── __init__.py     # Экспорт router + MENU_CONFIG (order: 30)
│       ├── router.py       # Обработчики для получения ID
│       └── messages.py     # Сообщения модуля
│
├── keyboards/              # Глобальные клавиатуры (только общие)
│   └── main_menu.py        # Динамическое главное меню
│
├── ADD_MODULE_GUIDE.md            # Руководство создания модулей
├── ARCHITECTURE_REFACTORING.md   # История рефакторинга архитектуры
└── google_cloud_full_setup.md    # Настройка Google Cloud для Gmail API
```

---

## 🧩 Как добавить свой модуль (plug-and-play)

1. **Создайте папку в `routers/` с именем вашего модуля**
2. Внутри создайте минимум:
   - `__init__.py` (экспортирует объект Router)
   - `router.py` (логика роутера)
   - `messages.py` (только сообщения этого модуля)
3. (Опционально) добавьте `config.py`, `keyboards.py`, `services/` для бизнес-логики
4. Все импорты должны быть локальными (например, `from .messages import MESSAGES`)
5. Не изменяйте другие файлы проекта — модуль должен работать независимо!
6. После добавления папки модуль автоматически подхватится системой автозагрузки роутеров

**Пример структуры нового модуля:**
```
routers/
  my_module/
    __init__.py
    router.py
    messages.py
    config.py           # Модульные настройки
    .env                # Секреты модуля (не в git)
    .env.example        # Шаблон секретов
    keyboards.py        # Клавиатуры модуля
    services.py         # Сервисы модуля
    auth/               # (опционально) OAuth авторизация
```

**Реальный пример - модуль `id_module`:**
```
routers/
  id_module/
    __init__.py         # from .router import id_module_router
    router.py           # Обработчики callback_query и message
    messages.py         # Сообщения для ID пользователя и чата
```

Этот модуль:
- Добавляет кнопку "🆔 Получить ID" в главное меню
- Отвечает ID пользователя и ID чата при нажатии кнопки
- Автоматически подключается при запуске бота

**Демонстрационный пример - модуль `test_module`:**
```
routers/
  test_module/
    __init__.py         # MENU_CONFIG с order: 15
    router.py           # Различные типы обработчиков
    messages.py         # Сообщения для тестирования
```

Этот модуль демонстрирует:
- Кнопку "🧪 Тест модуль" в главном меню (между email и id_module)
- Callback обработчик с информацией о пользователе и времени
- Text filter для сообщений со словом "тест"
- Emoji filter для реакции на 🧪
- Правильную позицию в меню благодаря `order: 15`

---

## ⚙️ Возможности

### 🏗️ **Устойчивая модульная архитектура**
- **🏠 Core модуль** - глобальные команды (`/start`, `/menu`) работают независимо от других модулей
- **🔧 True plug-and-play модули** - полностью автономные модули с автоматической регистрацией
- **🔐 Модульные секреты** - каждый модуль управляет своими `.env` файлами изолированно
- **📦 Переносимость** - модули можно переносить между проектами без изменений
- **🛡️ Безопасность** - модули не могут влиять друг на друга

### 📧 **Email функциональность**
- Отправка email с вложениями и текстом через Gmail API
- OAuth 2.0 авторизация с модульным управлением токенами
- Поддержка нескольких пользователей (`ALLOWED_USER_IDS`)
- Inline-меню управления:
  - Включение режима email
  - Смена получателя
  - Сброс черновика и файлов
  - Просмотр текущих вложений и email-адреса

### 🧩 **Демонстрационные модули**
- **🆔 ID модуль** - показывает ID пользователя и ID чата/группы
- **🧪 Тест модуль** - демонстрирует возможности (callback, text filters, emoji filters)
- **🌐 API пример** - показывает работу с модульными секретами и внешними API

### 📚 **Документация и рефакторинг**
- [📋 Руководство создания модулей](ADD_MODULE_GUIDE.md) - пошаговые инструкции
- [🏗️ История рефакторинга архитектуры](ARCHITECTURE_REFACTORING.md) - подробное описание улучшений

---

## 🛡 Безопасность

### 🔐 **Защита секретов**
- Все `.env` файлы (глобальные и модульные) исключены из git автоматически
- `token.pkl` и `client_secret.json` в модулях также защищены от публикации
- Каждый модуль изолирует свои секреты - модули не видят секреты друг друга

### ⚠️ **Важно**
- Не делитесь файлами `.env`, `token.pkl`, `client_secret.json` публично
- При переносе модуля между проектами пересоздайте секреты
- Используйте разные Gmail аккаунты для разных проектов

---

## ✅ Полезные команды
| Команда      | Описание                         |
|--------------|----------------------------------|
| `/start`     | Запуск и приветствие             |
| `/menu`      | Вызов основного меню             |

По-умолчанию выключен режим отправки имейлов, чтобы перейти в него, нужно нажать на кнопку из меню. Без входа в режим отправки бот в режиме echo - повторяет сообщения, написанные пользователем. Реализовано для тестирования.

---

## 📌 Советы

### 🚀 **Разработка**
- Изучите существующие модули (`email_router`, `test_module`) перед созданием своих
- Следуйте [руководству создания модулей](ADD_MODULE_GUIDE.md) для правильной архитектуры
- Тестируйте модули независимо - каждый должен работать как отдельное приложение

### 🔧 **Настройка**
- Используйте отдельный Gmail-аккаунт для работы бота
- Настройки email модуля находятся в `routers/email_router/.env`
- Копируйте шаблоны `.env.example` для быстрой настройки новых модулей

### 🖥️ **Развертывание**
- Можно развернуть на сервере с `pm2`, `systemd`, `screen` или `tmux`
- Бот будет работать даже если некоторые модули неправильно настроены
- Core команды (`/start`, `/menu`) всегда доступны

---

## 🔗 Лицензия
MIT. Используйте, развивайте и адаптируйте под себя.

---

## 👥 Авторы

**Оригинальный автор:** vladkolchik  
**Рефакторинг архитектуры (2025-01-15):** AI Assistant  

### 🏗️ История развития проекта
- **v1.0** - Базовая функциональность email бота
- **v2.0** - Модульная архитектура и автозагрузка роутеров  
- **v3.0** - Рефакторинг: core модуль, истинная модульность, модульные секреты

Подробнее в [документации рефакторинга](ARCHITECTURE_REFACTORING.md).