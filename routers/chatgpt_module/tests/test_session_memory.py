#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ ChatGPT –º–æ–¥—É–ª—è
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ—á–∏—Å—Ç–∫–∏ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', '..'))

from routers.chatgpt_module.memory_service import HybridMemoryService

def test_session_memory():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏"""
    print("üß™ –ù–∞—á–∏–Ω–∞—é —Ç–µ—Å—Ç —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏...")
    
    # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å –ø–∞–º—è—Ç–∏
    memory_service = HybridMemoryService()
    test_user_id = "test_user_123"
    
    print("\n1Ô∏è‚É£ –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –≤ —Å–µ—Å—Å–∏–æ–Ω–Ω—É—é –ø–∞–º—è—Ç—å:")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤
    dialogues = [
        ("–ü—Ä–∏–≤–µ—Ç!", "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"),
        ("–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?", "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç."),
        ("–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞?", "–Ø –Ω–µ –∑–Ω–∞—é, —É –º–µ–Ω—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –æ –ø–æ–≥–æ–¥–µ."),
        ("–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–º–æ—â—å", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω—É–∂–Ω–æ."),
    ]
    
    for user_msg, bot_response in dialogues:
        memory_service.save_to_session_memory(test_user_id, user_msg, bot_response)
        print(f"  ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω –¥–∏–∞–ª–æ–≥: '{user_msg}' -> '{bot_response}'")
    
    print("\n2Ô∏è‚É£ –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏:")
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Ç–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–æ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å)
    context = memory_service.get_session_context(test_user_id)
    print(f"  üìù –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ ({len(context.split('\\n')) - 1} –∑–∞–ø–∏—Å–µ–π):")
    
    for line in context.split('\n'):
        if line.strip():
            print(f"    {line}")
    
    print("\n3Ô∏è‚É£ –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏:")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = memory_service.get_session_memory_stats(test_user_id)
    print(f"  üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {stats}")
    
    print("\n4Ô∏è‚É£ –¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏:")
    
    # –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å
    memory_service.clear_session_memory(test_user_id)
    print("  üóëÔ∏è –°–µ—Å—Å–∏–æ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∞–º—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–µ–Ω–∞
    context_after_clear = memory_service.get_session_context(test_user_id)
    stats_after_clear = memory_service.get_session_memory_stats(test_user_id)
    
    print(f"  üìù –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: '{context_after_clear}'")
    print(f"  üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: {stats_after_clear}")
    
    if not context_after_clear and stats_after_clear['messages_count'] == 0:
        print("  ‚úÖ –°–µ—Å—Å–∏–æ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞")
    else:
        print("  ‚ùå –û—à–∏–±–∫–∞: –ø–∞–º—è—Ç—å –Ω–µ –±—ã–ª–∞ –æ—á–∏—â–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é")
    
    print("\nüéâ –¢–µ—Å—Ç —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω!")

if __name__ == "__main__":
    test_session_memory() 